// Arduino libraries
#include <Wire.h>
#include <Servo.h>
#include <PID_v1.h>

// Other libraries
#include "classes.h"

// Pin definitions
#define LED 13
#define PING_PIN 7
#define ACC_INT_PIN 6

#define ESC_N_PIN 9
#define ESC_E_PIN 7
#define ESC_S_PIN 8
#define ESC_W_PIN 9

#define ESC_PWM_MIN 1180
#define ESC_PWM_MAX 1710

// PID calibration values
#define KP 2
#define KI 5
#define KD 1

#define DEBUG

Acceleration Acc;
Rotation Rot;
Orientation Ori;
Distance Dis(PING_PIN);

// ESC N
Esc EscN;
Servo EscNServo;
PID EscNPID(&EscN.input, &EscN.output, &EscN.setpoint, KP, KI, KD, AUTOMATIC);

volatile boolean Interrupted = false;
double pulseWidth = ESC_PWM_MIN;

void setup()
{
  debug("Starting setup");
  Serial.begin(9600);
  Wire.begin();
  //accelInit();
  //gyroInit();
  EscNServo.attach(ESC_N_PIN, ESC_PWM_MIN, ESC_PWM_MAX);
  EscN.init(&EscNPID, &EscNServo);


  pinMode(ACC_INT_PIN, INPUT);
  attachInterrupt(0, setInterrupt, CHANGE);
  debug("Entering main loop");
}

void loop()
{
  int input;

  if (Serial.available() > 0) {
    input = Serial.read();
    switch (input) {
      case 49: pulseWidth = pulseWidth + 50; break;
      case 50: pulseWidth = pulseWidth - 50; break;
      default: Serial.print("Input: "); Serial.println(input); break;
    }

    Serial.println(pulseWidth);
    EscNServo.writeMicroseconds(pulseWidth);
    Serial.println(EscNServo.readMicroseconds());
  }

  //Serial.println(input, DEC);

  //Serial.print(EscN.input, DEC);
  //Serial.print(", ");
  //EscN.loopFunc();
  //Serial.println(EscN.setpoint, DEC);

  //accelerationUpdate(&Acc);
  //orientationUpdate(&Ori);
  //rotationUpdate(&Rot);

  //serialPrintSensorValues(&Acc, &Ori, &Rot);
  delay(100);
}
